name: Release

on:
  release:
    types: [published]

env:
  NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Extract version from release tag
      id: version
      run: |
        VERSION=${GITHUB_REF_NAME#v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Build Release
      run: dotnet build --configuration Release

    - name: Run tests
      run: dotnet test --configuration Release --no-build

    - name: Pack NuGet packages
      run: |
        dotnet pack src/LoMapper.Abstractions -c Release -o ./nuget-output /p:Version=${{ steps.version.outputs.VERSION }}
        dotnet pack src/LoMapper.Generator -c Release -o ./nuget-output /p:Version=${{ steps.version.outputs.VERSION }}

    - name: Create GitHub Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: "./nuget-output/*.nupkg"
        bodyFile: "CHANGELOG.md"
        draft: false
        prerelease: false

    - name: Publish to NuGet
      if: env.NUGET_API_KEY != ''
      run: |
        dotnet nuget push ./nuget-output/*.nupkg \
          --api-key ${{ env.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate

    - name: Comment on PR/Issue
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ… Release v${{ steps.version.outputs.VERSION }} created and published to NuGet!'
          })
      continue-on-error: true
